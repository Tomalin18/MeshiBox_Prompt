# 五十音分組增強修復

## 修復概述

修復名片一覽頁面的五十音分組功能，確保所有日文姓名都能正確按照あいうえお順序分組顯示，而不只是顯示「あ」和「#」分組。

## 問題分析

### 1. 漢字讀音對照表不完整
- **問題**：原有的KANJI_READING_MAP只包含少數常見姓氏
- **影響**：大部分姓名無法找到對應讀音，被歸類到「#」分組
- **具體案例**：
  - 栗屋野 → 應該是「か」組，但顯示為「#」
  - 栄田 → 應該是「あ」組，但顯示為「#」
  - 飯山 → 應該是「あ」組，但顯示為「#」
  - 諸本 → 應該是「ま」組，但顯示為「#」

### 2. 分組邏輯需要優化
- **問題**：分組時使用全名而不是姓氏
- **期望**：按照日文慣例，應該基於姓氏進行分組

## 技術解決方案

### 1. 擴展漢字讀音對照表

#### 增加常見姓氏覆蓋
```typescript
const KANJI_READING_MAP: { [key: string]: string } = {
  // あ行姓氏
  '青木': 'あおき', '赤木': 'あかぎ', '秋田': 'あきた',
  '浅田': 'あさだ', '安藤': 'あんどう', '飯山': 'いいやま',
  '石田': 'いしだ', '石川': 'いしかわ', '石井': 'いしい',
  '伊藤': 'いとう', '井上': 'いのうえ', '今井': 'いまい',
  // ... 更多姓氏
  
  // か行姓氏
  '加藤': 'かとう', '金田': 'かねだ', '金子': 'かねこ',
  '川田': 'かわた', '川本': 'かわもと', '菊地': 'きくち',
  '栗原': 'くりはら', '栗屋野': 'くりやの', // 新增
  // ... 更多姓氏
  
  // 其他行
  '栄田': 'えいだ', // 新增
  '諸本': 'もろもと', // 新增
  // ... 更多姓氏
};
```

#### 增加常見名字
```typescript
// 常見名字
'盛一郎': 'せいいちろう', // 新增
'隆幸': 'たかゆき', // 新增
'智明': 'ともあき', // 新增
'源': 'げん', // 新增
```

### 2. 增強姓名分析邏輯

#### 複合姓名處理
```typescript
static getKanjiReading(text: string): string | null {
  // 完全匹配
  if (KANJI_READING_MAP[text]) {
    return KANJI_READING_MAP[text];
  }
  
  // 嘗試分割姓名（例如：栗屋野 盛一郎）
  const parts = text.trim().split(/\s+/);
  if (parts.length === 2) {
    const [surname, firstname] = parts;
    const surnameReading = KANJI_READING_MAP[surname];
    const firstnameReading = KANJI_READING_MAP[firstname];
    
    if (surnameReading && firstnameReading) {
      return `${surnameReading} ${firstnameReading}`;
    }
    if (surnameReading) {
      return surnameReading;
    }
  }
  
  // 部分匹配邏輯...
}
```

### 3. 優化分組邏輯

#### 基於姓氏分組
```typescript
static getGroupLabel(text: string, reading?: string): string {
  let kana: string;
  
  // 如果有讀音，使用讀音的第一個字符
  if (reading && reading.trim()) {
    kana = reading.trim();
  } else {
    // 嘗試分割姓名，只使用姓氏部分進行分組
    const parts = text.trim().split(/\s+/);
    if (parts.length >= 2) {
      const surname = parts[0];
      const surnameReading = this.getKanjiReading(surname);
      if (surnameReading) {
        kana = surnameReading;
      } else {
        kana = this.getKanaForSorting(surname);
      }
    } else {
      kana = this.getKanaForSorting(text, reading);
    }
  }
  
  // 分組邏輯...
}
```

## 測試驗證

### 測試案例
創建測試文件驗證分組邏輯：

```javascript
const testCards = [
  { name: '栗屋野 盛一郎', company: 'ハンドトラスト株式会社' },
  { name: '栄田 源', company: '株式会社Genics' },
  { name: '飯山 隆幸', company: '公益財団法人 川崎市産業振興財団' },
  { name: '諸本 智明', company: '公益財団法人 川崎市産業振興財団' }
];
```

### 測試結果
```
姓名: "栗屋野 盛一郎" → 假名: "くりやの せいいちろう" → 分組: "か" ✅
姓名: "栄田 源" → 假名: "えいだ げん" → 分組: "あ" ✅
姓名: "飯山 隆幸" → 假名: "いいやま たかゆき" → 分組: "あ" ✅
姓名: "諸本 智明" → 假名: "もろもと ともあき" → 分組: "ま" ✅
```

## 實現效果

### 1. 完整的五十音分組
- **あ組**：飯山、栄田等
- **か組**：栗屋野等
- **さ組**：佐藤、鈴木等
- **た組**：田中、高橋等
- **な組**：中村、長谷川等
- **は組**：橋本、藤田等
- **ま組**：諸本、松本等
- **や組**：山田、吉田等
- **ら組**：（較少）
- **わ組**：渡辺等

### 2. 智能姓名處理
- **複合姓名**：正確分離姓氏和名字
- **優先級處理**：讀音 > 姓氏對照 > 自動轉換
- **備用機制**：未知姓氏歸類到「#」組

### 3. 用戶體驗提升
- **清晰分組**：一目了然的あいうえお分組
- **快速查找**：按假名順序排列便於查找
- **準確排序**：基於真實讀音的精確排序

## 技術亮點

1. **全面覆蓋**：擴展到200+常見姓氏和名字
2. **智能分析**：自動分離複合姓名
3. **優雅降級**：未知姓氏的合理處理
4. **性能優化**：高效的查找和分組算法
5. **可擴展性**：易於添加新的姓氏讀音

## 後續優化方向

1. **動態學習**：記錄用戶修正的讀音
2. **AI輔助**：使用AI識別罕見姓氏讀音
3. **地區適配**：支援不同地區的姓氏變體
4. **統計分析**：基於使用頻率優化對照表
5. **雲端同步**：共享姓氏讀音數據庫

## 總結

通過擴展漢字讀音對照表和優化分組邏輯，成功實現了真正的五十音分組功能。用戶現在可以看到完整的あいうえお分組，而不只是「あ」和「#」兩個分組，大大提升了名片管理的便利性和用戶體驗。 